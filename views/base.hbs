<div class="users-container">
  <div class="header-section" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h1 class="page-title">База пользователей</h1>

      <div class="filter-section">
        <div class="filter-item active">
          <span>Все пользователи</span>
        </div>
        <div class="filter-item">
          <span>Пользователь</span>
        </div>
        <div class="filter-item">
          <span>Администратор</span>
        </div>
      </div>
    </div>

    <div class="search-container" style="margin-top: 10px;">
      <div class="input-field">
        <input id="search" type="text" placeholder="Поиск пользователей...">
        <i class="material-icons prefix" style="position: absolute; right: 10px; top: 10px;">search</i>
      </div>
    </div>
  </div>

  <div class="divider"></div>

  <div class="users-table">
    <table class="highlight responsive-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Имя</th>
          <th>Email</th>
          <th>Телефон</th>
          <th>Активность</th>
          <th>Роль</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
        {{#each base}}
          <tr>
            <td>{{ID}}</td>
            <td>{{user_fullname}}</td>
            <td><a href="mailto:{{email}}">{{email}}</a></td>
            <td><a href="tel:{{telphone}}">{{telphone}}</a></td>
            <td>
              {{#if (eq order_count 0)}}
                Нет заказов
              {{else}}
                {{order_count}} 
              {{/if}}
            </td>
            <td><{{role}}></span></td>
            <td>
              <a class="btn-flat waves-effect tooltipped delete-user" data-tooltip="Удалить" data-position="top" data-id="{{ID}}">
                <i class="material-icons">delete</i>
              </a>
            </td>
          </tr>
        {{/each}}
      </tbody>
    </table>
  </div>
</div>

<!-- Модальное окно -->
<div id="delete-modal" class="modal">
  <div class="modal-content">
    <h4>Подтверждение удаления</h4>
    <p>Вы уверены, что хотите удалить этого пользователя?</p>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn-flat">Отмена</a>
    <a href="#!" id="confirm-delete-btn" class="btn-flat red-text text-accent-2">Удалить</a>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    M.Modal.init(document.querySelectorAll('.modal'));

    let userIdToDelete = null;

    document.querySelectorAll('.delete-user').forEach(btn => {
      btn.addEventListener('click', function () {
        userIdToDelete = this.dataset.id; // Получаем ID из data-id
        const modal = M.Modal.getInstance(document.getElementById('delete-modal'));
        modal.open();
      });
    });

    document.getElementById('confirm-delete-btn').addEventListener('click', async function () {
      if (!userIdToDelete) return;

      try {
        const response = await fetch('/delete-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: userIdToDelete })
        });

        if (response.ok) {
          window.location.reload(); 
        } else {
          alert('Ошибка при удалении');
        }
      } catch (error) {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при удалении.');
      }
      userIdToDelete = null;
    });
  });
</script>
